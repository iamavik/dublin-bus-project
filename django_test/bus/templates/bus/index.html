
<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>Dublin Bus App</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    
    <body>
        <h1 align="center">Dublin Bus App</h1>
        <div id="map" style="width:100%;height:300px;"></div>
<!--
        <form action="/search/" method="get">
        <input type="text" name="q">
        <input type="submit" value="Search">
    </form>
    -->  
Source: <input id="searchTextField" type="text" size="50" placeholder="Enter starting point" autocomplete="on" runat="server" onclick="initialize()"/> 
Destination: <input id="searchTextField2" type="text" size="50" placeholder="Enter ending point" autocomplete="on" runat="server" onclick="initialize2()" />
<input type="submit" name="Submit" value="Go Now" onclick="return test_func();"/>
<input type="submit" name="Submit2" value="Plan Your Trip" />
		<p>Total Distance to destination<p id="demo1"></p></p>
        <p><b> Directions to the closest Departure Bus Stop      </b></p>
        
        <p id="demo2"></p>
        <p>Distance to walk<p id="demo3"></p></p>
        <p>Approx time to walk to bus stop:<p id="demo4"></p></p>
        <p><b> Nearest bus stop close to your destination: </b></p>
        <p><b>Departure Bus Stop related info </b></p>
        <p id="demo5"></p>
        <p>Distance to the arrival bus stop<p id="demo5"></p></p>
        <p>Departure Bus Stop Name:<p id = "demo6"></p></p>
        <p>Your Bus:<p id = "demo9"></p></p>
        <p>Departure time:<p id = "demo7"></p></p>
        <p>Headsign:<p id = "demo8"></p></p>
        <p>Number of stops to travel:<p id = "demo10"></p></p>
        <p><b> Arrival Bus Stop Related Information      </b></p>
        <p>Arrival Stop:<p id = "demo11"></p></p>
        
        <p>Distance to walk:<p id = "demo13"></p></p>
        <p>Approximate Time:<p id = "demo14"></p></p>
        <p id="demo15"></p>
        <p id = "demo16"></p>


   
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
       
        <script>

        	//var myObj=  "{{result}}";

        //	var myObj = JSON.parse("{{result}}".replace(/&quot;/g,"\""));  Commenting 15/06

          
//document.getElementById("demo1").innerHTML=myObj;

    /*   
    var myObj = [[53.3052408766,-6.21711804472,"Belfield University College Dublin",767],[53.30496107,-6.21703967,"Belfield, University College Dublin",4953],[53.34657961,-6.260483805,"Temple Bar, Aston Quay",326],[53.34642645,-6.261075822,"Temple Bar, Aston Quay",328]];
    */
    //document.getElementById("demo1").innerHTML=myObj;
    /* Commenting 15/06
    var lat=new Array(myObj.length);
	var long=new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
            {
              lat[i]=myObj[i][0];
           //   document.getElementById("demo1").innerHTML=lat[0];
            }
  // document.getElementById("demo3").innerHTML=lat;
     //To get the list of longitude of stations
            for(var i=0;i<myObj.length;i++)
            {
          
                long[i]=myObj[i][1];
            }
        
    
    //To get the list of latitude and longitude of stations as a tuple 
            var latlong=new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
                {
                    latlong[i]=[lat[i],long[i]];
                }
   
    
    //To fetch the list of station names
            var address_2=new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
                {
                address_2[i]=myObj[i][2];
                }
            var bus_stop_no = new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
                {
                    bus_stop_no[i] = myObj[i][3];
                }
            var infowindow;
    
     //To set up the map with desired properties
            function myMap() {
                var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 14};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    });    
                for(var j=0;j<latlong.length;j++)
                {
                    var marker=new google.maps.Marker({
                    position:new google.maps.LatLng(latlong[j][0],latlong[j][1]),
                    map:map,
                    addre:address_2[j],
                    latitiude:lat[j],
                    longitude:long[j],
                    bus_stop:bus_stop_no[j]
            });
      popupDirections(marker);
    
                }
      
            }
            function popupDirections(marker) {
            
                //This function created listener listens for click on a marker to show information specific to that marker
                google.maps.event.addListener(marker, 'click', function () {
                for (var i = 0; i <address_2.length; i++)
                { infowindow.setContent("Address: " + marker.addre +"<br>"+"Latitude:" + marker.latitiude+"<br>"+"Longitude:"+marker.longitude+"<br>"+"Bus-Stop:" + marker.bus_stop); } infowindow.open(map, marker); //This opens the infowindow at the marker
                });
            }
            
            //This function finds the closest station corresponding to the chosen source and destination by the user
            
            function getDistanceFromLatLonInKm(latitude,longitude,m) {
                var x= latitude; 
                var y=longitude;
                var closest_location;  
                var min=0;
                var axis=0;
                var value=0;
                var dist_array=new Array(latlong.length);
                for(var i=0;i<latlong.length;i++)
                {
                    axis=((x-latlong[i][0])*(x-latlong[i][0]))+((y-latlong[i][1])*(y-latlong[i][1]))
                    value=Math.sqrt(axis);
                    dist_array[i]=value;
                }
                    var min = Math.min.apply(Math, dist_array);
                    var idx=dist_array.indexOf(Math.min.apply(null,dist_array))
                    var nearest_station=address_2[idx];
                    if(m==0)
                    {
                        document.getElementById("demo4").innerHTML="the average time to the bus stop is "+min*1000/1.4; 
                        document.getElementById("demo2").innerHTML="The nearest station to your souce coordinate is "+nearest_station;  
            
                    }
                    else{
        
                        document.getElementById("demo5").innerHTML="the average time to the destination bus stop is "+min*1000/4; 
                        document.getElementById("demo6").innerHTML="The nearest station to your destination coordinate is "+nearest_station;  
                    }
                }
    
                //This function is triggered whenver user clicks on "Enter starting point" field to enter the source
                
                function initialize() {
                    var input = document.getElementById('searchTextField');
                    var autocomplete = new google.maps.places.Autocomplete(input);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude = place.geometry.location.lat();
                        var longitude=place.geometry.location.lng();
                        var m=0;
                        getDistanceFromLatLonInKm(latitude,longitude,m);
                    });
        
                }
                //This function is triggered whenver user clicks on "Enter ending point" field to enter the destination
    
    
                function initialize2() {
                    var input = document.getElementById('searchTextField2');
                    var autocomplete = new google.maps.places.Autocomplete(input);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude = place.geometry.location.lat();
                        var longitude=place.geometry.location.lng();
                        var m=1;
         
                        getDistanceFromLatLonInKm(latitude,longitude,m);
           
                    });
                }
                
                google.maps.event.addDomListener(window, 'load', initialize); 

                */ //Commenting 15/06
                
                function myMap() {
                var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 14};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    });    
            }
               function change_map(myObj) {
       			var directionsDisplay = new google.maps.DirectionsRenderer;
        		var directionsService = new google.maps.DirectionsService;

        		var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 14};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    }); 

        
        directionsDisplay.setMap(map);

        calculateAndDisplayRoute(directionsService, directionsDisplay,myObj);
       
      }

      var arr = new Array(4);


      /* Commented on 16-06
      function get_latitude_and_longitude(address)
      {
      	 var arr = new Array(2);
      	geocoder = new google.maps.Geocoder();
           geocoder.geocode( { 'address' : address }, function( results, status ) {
           	var latitude1 = results[0].geometry.location.lat();
           	var longitude1 =  results[0].geometry.location.lng()
           	arr[0] = latitude1;
           	arr[1] = longitude1;
           return arr;
       
    } );


      }*/ 

      function calculateAndDisplayRoute(directionsService, directionsDisplay,myObj) {
        var selectedMode = "TRANSIT";
        var origin_stop_name = myObj[0][4];  
         var dest_stop_name = myObj[1][4];  
         
          var source = document.getElementById("searchTextField").value;
          var dest  = document.getElementById("searchTextField2").value;
          var latitude1 = arr[0];
          var longitude1 = arr[1];
          var latitude2 = arr[2];
          var longitude2 = arr[3];

        directionsService.route({
        	
          origin: {lat: latitude1, lng: longitude1},  // UCD
          destination: {lat: latitude2, lng: longitude2},  // Temple Bar.
          // Note that Javascript allows us to access the constant
          // using square brackets and a string value as its
          // "property."
          travelMode: google.maps.TravelMode[selectedMode]
        }, function(response, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }

      function display_direction_data(direction_data)
      {
      	document.getElementById("demo1").innerHTML = direction_data[1];
      	document.getElementById("demo2").innerHTML = direction_data[2];
      	document.getElementById("demo3").innerHTML = direction_data[3];
      	document.getElementById("demo4").innerHTML = direction_data[4];
      	document.getElementById("demo5").innerHTML = direction_data[6];
      	document.getElementById("demo6").innerHTML = direction_data[8]
      	document.getElementById("demo7").innerHTML = direction_data[9];
      	document.getElementById("demo8").innerHTML = direction_data[10];
      	document.getElementById("demo9").innerHTML = direction_data[11];
      	document.getElementById("demo10").innerHTML = direction_data[12];
      	document.getElementById("demo11").innerHTML = direction_data[13];
      	//document.getElementById("demo12").innerHTML = direction_data[14];
      	document.getElementById("demo13").innerHTML = direction_data[15];
      	document.getElementById("demo14").innerHTML = direction_data[16];







      }
            function initialize() {
                    var input = document.getElementById('searchTextField');
                    var autocomplete = new google.maps.places.Autocomplete(input);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude1 = place.geometry.location.lat();
                        var longitude1=place.geometry.location.lng();
                        arr[0] = latitude1;
                        arr[1] = longitude1;
                       
                        //var m=0;
                       // getDistanceFromLatLonInKm(latitude,longitude,m);
                    });
        
                }
                 function initialize2() {
                    var input = document.getElementById('searchTextField2');
                    var autocomplete = new google.maps.places.Autocomplete(input);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude2 = place.geometry.location.lat();
                        var longitude2=place.geometry.location.lng();
                        arr[2] = latitude2;
                        arr[3] = longitude2;
                       // document.getElementById("demo6").innerHTML = arr.length;
                      //  test_func();
                      //  var m=1;
         
                     //   getDistanceFromLatLonInKm(latitude,longitude,m);
           
                    });
                }
                function test_func()
                {
                	var source = document.getElementById("searchTextField").value;
                var dest  = document.getElementById("searchTextField2").value;
                //document.getElementById("demo1").innerHTML = source;
                //document.getElementById("demo3").innerHTML = dest;
                var origin = source;
                var destination = dest;

               $.ajax({
   					type: "POST",
   					url: '{{ 'my-ajax-test/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}', origin: origin, destination:destination },
   					success: function(response){
               		console.log(response);
               		//var myObj = JSON.parse("response".replace(/&quot;/g,"\""));
               		if(response=="Error")
               		{
               			alert("Currently no nearby bus stops seems to be operating...kindly try again in some time")
               		}
               		else
               		{
               			var myObj =  JSON.parse(response);
               		//document.getElementById("demo5").innerHTML=myObj.result;
               		var result_data = JSON.parse(myObj.result);
               		//document.getElementById("demo6").innerHTML= result_data[0];
               		var direction_data = myObj.list_with_direction;
               		//document.getElementById("demo1").innerHTML = direction_data[0];

               		change_map(result_data);
               		display_direction_data(direction_data);


               		}
               		

               		 //window.location = 'bus/real_time_route.html';

            }

   				
});
        return false;

                }

                // Fetching weather data: related code Adding on 19/06

                //Fetching weather data from Open Weather API. This script is executed only once when the page loads for the first time
                $.ajax({
   					type: "POST",
   					url: '{{ 'my-weather-data/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}', data:0 },
   					success: function(response){
               		console.log(response);
               		//var myObj = JSON.parse("response".replace(/&quot;/g,"\""));
               		
               		

               		 //window.location = 'bus/real_time_route.html';

            }

   				
});
                // Fetching data directly from the OpenWeather API after every 5000 seconds to auto - update the weather related deatils

                var myVar=setInterval(myTimer,100000);
                function myTimer()
                {
                	      $.ajax({
   					type: "POST",
   					url: '{{ 'my-weather-data/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}', data:0 },
   					success: function(response){
               		console.log(response);
               		//var myObj = JSON.parse("response".replace(/&quot;/g,"\""));
               		
               		

               		 //window.location = 'bus/real_time_route.html';

            }

   				
});


                }

          
                /* Commented on 19-06 (Getting weather details code)

                // Fetch real-time weather data on page load
$.getJSON("http://api.openweathermap.org/data/2.5/weather?id=7778677&APPID=a4822db1b5634c2e9e25209d1837cc69&units=metric",
  function(response_5) {
    document.getElementById("coverage").innerHTML = response_5.weather[0].main;
    document.getElementById("temp").innerHTML = response_5.main.temp + "°C";
    document.getElementById("wind").innerHTML = response_5.wind.speed + "km/h";
  })

// function to call the weather forecast route every 5000 sec
var myVar=setInterval(myTimer,100000);
function myTimer() {
  $.getJSON($SCRIPT_ROOT + '/weather', {post: 0}, function(data) {
    var response_3=({{ data|safe }})
    var response_3 = data;
    document.getElementById("coverage").innerHTML = response_3[2];
    document.getElementById("temp").innerHTML = response_3[0] + "°C";
    document.getElementById("wind").innerHTML = response_3[1] + "km/h";
  })
}
*/
            
            google.maps.event.addDomListener(window, 'load', initialize); 
        
        </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBi-bH5_sngxNibrgygRZDhmAv2fK5hzus&callback=myMap&libraries=places"></script>
    </body>
</html>


<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>Dublin Bus App</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
table, td {
  border: 1px solid black;
}
select.initial_hide_2
{
	display: none;

}

p.initial-hide{
	display: none;
}

select.initial_hide{
	display: none;
}
</style>
    </head>
    
    <body>
        <h1 align="center">Dublin Bus App</h1>
        <div id="map" style="width:100%;height:300px;"></div>
<!--
        <form action="/search/" method="get">
        <input type="text" name="q">
        <input type="submit" value="Search">
    </form>
    -->  
Source: <input id="searchTextField" type="text" size="50" placeholder="Enter starting point" autocomplete="on" runat="server" onclick="initialize()"/> 
Destination: <input id="searchTextField2" type="text" size="50" placeholder="Enter ending point" autocomplete="on" runat="server" onclick="initialize2()" />
Date of Trip:
  <input id="mydate" type="date" name="tripday"  max="2019-12-31">
  Time: <input type="time" id="mytime" min="05:30" max="23:59">
<input type="submit" name="Submit" value="Check Now" onclick="return test_func();"/>
<!--<input type="submit" name="Submit2" value="Plan Your Trip" />-->
  
         <!--This drop down is for selecting a Bus Line by the user-->

         <select class="initial_hide" id="select">
            <!--<option value="default">default</option>-->
        </select>
       <button onclick="getLocation()">Find nearest bus stops</button>
       <button onclick="savetrip()"> Save a Trip as Favourite</button>
       <button onclick="fetchsavedtrips()"> Show Favourites</button>
        Data is<p id="test"></p>
        <br><br>
        <!--
        <input type="radio" name="rd1" id="tourist" onchange="TouristMode()">Tourist Mode
        <input type=button value="Turn Off Tourist Mode" onclick=
"document.getElementById('tourist').checked = false">-->
<input type="checkbox" id="tourist" onchange="TouristMode()"> Tourist Mode

<p id="tourist_info" class="initial-hide">Popular Places to Visit:</p>

 <!--This drop down is for selecting a Tourist Destination by the user-->

<select class="initial_hide_2"  id="select2" onchange="getSelectedValue()">
           
        </select>
        
        <p id="showlatlng"></p>
          
  <!--
        <div id="info_panel">
		<p>Total Distance to destination<p id="demo1"></p></p>
        <p><b> Directions to the closest Departure Bus Stop      </b></p>
        
        <p id="demo2"></p>
        <p>Distance to walk<p id="demo3"></p></p>
        <p>Approx time to walk to bus stop:<p id="demo4"></p></p>
        <p><b> Nearest bus stop close to your destination: </b></p>
        <p><b>Departure Bus Stop related info </b></p>
        <p id="demo5"></p>
        <p>Distance to the arrival bus stop<p id="demo5"></p></p>
        <p>Departure Bus Stop Name:<p id = "demo6"></p></p>
        <p>Your Bus:<p id = "demo9"></p></p>
        <p>Departure time:<p id = "demo7"></p></p>
        <p>Headsign:<p id = "demo8"></p></p>
        <p>Number of stops to travel:<p id = "demo10"></p></p>
        <p><b> Arrival Bus Stop Related Information      </b></p>
        <p>Arrival Stop:<p id = "demo11"></p></p>
        
        <p>Distance to walk:<p id = "demo13"></p></p>
        <p>Approximate Time:<p id = "demo14"></p></p>
        <p id="demo15"></p>
        <p id = "demo16"></p>
    </div>
-->
Saved Trips are:
<table id="myTable">

</table>

<p id="demo1"></p>
<p id="demo2"></p>
<p id="demo3"></p>
<p id="demo4"></p>
 <p id="demo5"></p>
 <p id = "demo6"></p>
 <p id = "demo7"></p>
 	<p id = "demo8"></p>
 	<p id = "demo9"></p>
 <p id = "demo10"></p>
 <p id = "demo11"></p>
 <p id = "demo12"></p>
 <p id = "demo13"></p>
 <p id = "demo14"></p>




   
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
       
        <script>

   

        	//var myObj=  "{{result}}";

        //	var myObj = JSON.parse("{{result}}".replace(/&quot;/g,"\""));  Commenting 15/06

          
//document.getElementById("demo1").innerHTML=myObj;

    /*   
    var myObj = [[53.3052408766,-6.21711804472,"Belfield University College Dublin",767],[53.30496107,-6.21703967,"Belfield, University College Dublin",4953],[53.34657961,-6.260483805,"Temple Bar, Aston Quay",326],[53.34642645,-6.261075822,"Temple Bar, Aston Quay",328]];
    */
    //document.getElementById("demo1").innerHTML=myObj;
    /* Commenting 15/06
    var lat=new Array(myObj.length);
	var long=new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
            {
              lat[i]=myObj[i][0];
           //   document.getElementById("demo1").innerHTML=lat[0];
            }
  // document.getElementById("demo3").innerHTML=lat;
     //To get the list of longitude of stations
            for(var i=0;i<myObj.length;i++)
            {
          
                long[i]=myObj[i][1];
            }
        
    
    //To get the list of latitude and longitude of stations as a tuple 
            var latlong=new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
                {
                    latlong[i]=[lat[i],long[i]];
                }
   
    
    //To fetch the list of station names
            var address_2=new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
                {
                address_2[i]=myObj[i][2];
                }
            var bus_stop_no = new Array(myObj.length);
            for(var i=0;i<myObj.length;i++)
                {
                    bus_stop_no[i] = myObj[i][3];
                }
            var infowindow;
    
     //To set up the map with desired properties
            function myMap() {
                var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 14};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    });    
                for(var j=0;j<latlong.length;j++)
                {
                    var marker=new google.maps.Marker({
                    position:new google.maps.LatLng(latlong[j][0],latlong[j][1]),
                    map:map,
                    addre:address_2[j],
                    latitiude:lat[j],
                    longitude:long[j],
                    bus_stop:bus_stop_no[j]
            });
      popupDirections(marker);
    
                }
      
            }
            function popupDirections(marker) {
            
                //This function created listener listens for click on a marker to show information specific to that marker
                google.maps.event.addListener(marker, 'click', function () {
                for (var i = 0; i <address_2.length; i++)
                { infowindow.setContent("Address: " + marker.addre +"<br>"+"Latitude:" + marker.latitiude+"<br>"+"Longitude:"+marker.longitude+"<br>"+"Bus-Stop:" + marker.bus_stop); } infowindow.open(map, marker); //This opens the infowindow at the marker
                });
            }
            
            //This function finds the closest station corresponding to the chosen source and destination by the user
            
            function getDistanceFromLatLonInKm(latitude,longitude,m) {
                var x= latitude; 
                var y=longitude;
                var closest_location;  
                var min=0;
                var axis=0;
                var value=0;
                var dist_array=new Array(latlong.length);
                for(var i=0;i<latlong.length;i++)
                {
                    axis=((x-latlong[i][0])*(x-latlong[i][0]))+((y-latlong[i][1])*(y-latlong[i][1]))
                    value=Math.sqrt(axis);
                    dist_array[i]=value;
                }
                    var min = Math.min.apply(Math, dist_array);
                    var idx=dist_array.indexOf(Math.min.apply(null,dist_array))
                    var nearest_station=address_2[idx];
                    if(m==0)
                    {
                        document.getElementById("demo4").innerHTML="the average time to the bus stop is "+min*1000/1.4; 
                        document.getElementById("demo2").innerHTML="The nearest station to your souce coordinate is "+nearest_station;  
            
                    }
                    else{
        
                        document.getElementById("demo5").innerHTML="the average time to the destination bus stop is "+min*1000/4; 
                        document.getElementById("demo6").innerHTML="The nearest station to your destination coordinate is "+nearest_station;  
                    }
                }
    
                //This function is triggered whenver user clicks on "Enter starting point" field to enter the source
                
                function initialize() {
                    var input = document.getElementById('searchTextField');
                    var autocomplete = new google.maps.places.Autocomplete(input);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude = place.geometry.location.lat();
                        var longitude=place.geometry.location.lng();
                        var m=0;
                        getDistanceFromLatLonInKm(latitude,longitude,m);
                    });
        
                }
                //This function is triggered whenver user clicks on "Enter ending point" field to enter the destination
    
    
                function initialize2() {
                    var input = document.getElementById('searchTextField2');
                    var autocomplete = new google.maps.places.Autocomplete(input);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude = place.geometry.location.lat();
                        var longitude=place.geometry.location.lng();
                        var m=1;
         
                        getDistanceFromLatLonInKm(latitude,longitude,m);
           
                    });
                }
                
                google.maps.event.addDomListener(window, 'load', initialize); 

                */ //Commenting 15/06
                
                function myMap() {
                var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 14};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    });    
            }
               function change_map(list_intermediate_bus_stops,list_bus_lines,direction_data,departure_date_time) {
       			var directionsDisplay = new google.maps.DirectionsRenderer;
        		var directionsService = new google.maps.DirectionsService;

        		var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 14};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    }); 
                directionsDisplay.setMap(map);
                
                //google.maps.SymbolPath.CIRCLE
                //google.maps.SymbolPath.FORWARD_CLOSED_ARROW

                /*
                var whiteCircle = {
    path: google.maps.SymbolPath.CIRCLE,
    fillOpacity: 1.0,
    fillColor: "black",
    strokeOpacity: 1.0,
    strokeColor: "white",
    strokeWeight: 1.0,
    scale: 3.5
};
                
		for(var i = 0;i<1;i++)
		{
			for(var j =0;j<list_intermediate_bus_stops[i].length;j++)
			{
						var myLatlng = new google.maps.LatLng(list_intermediate_bus_stops[i][j][2],list_intermediate_bus_stops[i][j][3]);
						var marker = new google.maps.Marker({
    					position: myLatlng,
    					icon: whiteCircle,
    					stop_no: list_intermediate_bus_stops[i][j][0],
    					stop_name: list_intermediate_bus_stops[i][j][4]
            
          
   						 
});
					
// To add the marker to the map, call setMap();
marker.setMap(map);
popupDirections(marker);


			}
	
		}

	
            function popupDirections(marker) {
            
                //This function created listener listens for click on a marker to show information specific to that marker
                google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent('<b>'+"Stop No:"+'</b>'+marker.stop_no+'<br>'+'<b>'+"Stop Name:"+'</b>'+marker.stop_name);  infowindow.open(map, marker); //This opens the infowindow at the marker
                });
            }*/


             var flag = 0;

      var onChangeHandler = function() {
      		flag=1;
          calculateAndDisplayRoute(directionsService, directionsDisplay,flag,list_bus_lines,direction_data,list_intermediate_bus_stops,map,departure_date_time);
        };
        document.getElementById('select').addEventListener('change', onChangeHandler);
        
       
        calculateAndDisplayRoute(directionsService, directionsDisplay,flag,list_bus_lines,direction_data,list_intermediate_bus_stops,map,departure_date_time);
       
      }

      var arr = new Array(4);


      /* Commented on 16-06
      function get_latitude_and_longitude(address)
      {
      	 var arr = new Array(2);
      	geocoder = new google.maps.Geocoder();
           geocoder.geocode( { 'address' : address }, function( results, status ) {
           	var latitude1 = results[0].geometry.location.lat();
           	var longitude1 =  results[0].geometry.location.lng()
           	arr[0] = latitude1;
           	arr[1] = longitude1;
           return arr;
       
    } );


      }*/ 

      function calculateAndDisplayRoute(directionsService, directionsDisplay,flag,list_bus_lines,direction_data,list_intermediate_bus_stops,map,departure_date_time) {
        var data = document.getElementById('select').value;
        //console.log("First data is",data)
        var selectedMode = "TRANSIT";
      //  var origin_stop_name = myObj[0][4];  
      //   var dest_stop_name = myObj[1][4];  
     
      document.getElementById('select').style.display = 'block';  //Can be later used with CSS to unhide the drop_down bus line which was hidden on page load
         
          var source = document.getElementById("searchTextField").value;
          var dest  = document.getElementById("searchTextField2").value;
          var selected_date = document.getElementById("mydate").value;
          var selected_time = document.getElementById("mytime").value;
          var date,date_list,hr_mins,departure_time;
          if(selected_date=='' && selected_time=='')
          {
          	var departure_time = departure_date_time;
          	//var departure_time = Math.round(+new Date()/1000);
          	console.log("if no depart time selected..current time");
          	console.log(departure_time);
          	//date = new Date();
          }
          else
          {
          //	var date_list =  selected_time.split("-");
          //	var hr_mins = selected_time.split(":");
          	var departure_time = departure_date_time;
          	console.log("if departure date and time selected");
          	console.log(departure_time);
          	//date = new Date(parseInt(date_list[0]),parseInt(date_list[1])-1,parseInt(date_list[2]),parseInt(hr_mins[0]),parseInt(hr_mins[1]));
          }
          console.log(departure_time);
          //var latitude1 = arr[0]; Not required as now we use origin as String and no need to use latitude and longitude of the place
          //var longitude1 = arr[1];
          //var latitude2 = arr[2];
          //var longitude2 = arr[3];

      

          var origin = document.getElementById("searchTextField").value;
          var destination = document.getElementById("searchTextField2").value;

        directionsService.route({
        	
          origin: origin,  // UCD
          destination: destination,  // Temple Bar.
          // Note that Javascript allows us to access the constant
          // using square brackets and a string value as its
          // "property."
          provideRouteAlternatives: true,
          travelMode: google.maps.TravelMode[selectedMode],
          transitOptions: {
          	departureTime: new Date(departure_time*1000),
    modes: ['BUS']
   
  }
        }, function(response, status) {
          if (status == 'OK') {
          	console.log("Google response",response);
          	 console.log("Data is",data);
          	  var arr1 = new Array();
              for(var i=0;i<response['routes'].length;i++)
                  {
                      for(var j=0;j<response['routes'][i]['legs'][0]['steps'].length;j++)
                          {
                        if(response['routes'][i]['legs'][0]['steps'][j]['travel_mode']=="TRANSIT")
                            {
                                if(j>1)
                                    {
                                        var bus_transfer = response['routes'][i]['legs'][0]['steps'][1]['transit']['line']['short_name'].toUpperCase()+"/"+response['routes'][i]['legs'][0]['steps'][j]['transit']['line']['short_name'].toUpperCase();
                                        arr1.pop();
                                        arr1.push(bus_transfer);
                                    }
                                else{
                                    arr1.push(response['routes'][i]['legs'][0]['steps'][j]['transit']['line']['short_name'].toUpperCase());
                                }
                            }
                          }
                  }

                  console.log(arr1);
                  var intersection_result = arr1.filter(function(n) {
  return list_bus_lines.indexOf(n) > -1;
});
                  console.log(intersection_result);



                 //if(data=="default")
                 if(flag==0)
                  {
                  	document.getElementById("select").innerHTML="";
                       for(var i = 0; i <arr1.length; i++)
             {
                 var option = document.createElement("OPTION"),
                     txt = document.createTextNode(arr1[i]);
                 option.appendChild(txt);
                 option.setAttribute("value",i);
                 select.insertBefore(option,select.lastChild);
             }
                      directionsDisplay.setDirections(response);
                  }
            else
                  {
                      data = parseInt(data);
                    //   directionsDisplay.setDirections(response);
                      directionsDisplay.setRouteIndex(data); 
                      
                  }
                  if(data=="")
                  {
                  	data=0;
                  }
                  if(list_bus_lines.includes(arr1[data]))
                  {
                  	var data2  = list_bus_lines.indexOf(arr1[data]);
                  	console.log("Chosen index of data");
                  	console.log(data2);
                  	display_direction_data(direction_data,data,data2,list_intermediate_bus_stops,map);
                  }
                  else
                  {
                  	//Note: Create display_direction_data_new to display direction data from front end itself and not backend
                  	display_direction_data_front_end(response,data);
                  }
                  /*
                  if(intersection_result.length!=0)
                  {
                  	display_direction_data_intersection(direction_data,data)
                  }*/
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }
      var flag2 = 0;
    var global_list = new Array();
    var markers = [];

      function display_direction_data(direction_data,data,data2,list_intermediate_bus_stops,map,directionsDisplay)
      {
      	var directionsDisplay = new google.maps.DirectionsRenderer;
      	directionsDisplay.setMap(map);
      

      		   var whiteCircle = {
    path: google.maps.SymbolPath.CIRCLE,
    fillOpacity: 1.0,
    fillColor: "black",
    strokeOpacity: 1.0,
    strokeColor: "white",
    strokeWeight: 1.0,
    scale: 3.5
};
var list = list_intermediate_bus_stops[data2];
console.log("List is");
console.log(list);
      	document.getElementById("test").innerHTML=data;
      	if(direction_data.length==data)
      	{
      		data = direction_data.length-1;
      	}
      	if(direction_data[data].length==18) //This is to diplay single bus journey. The length of it is still 18. For bus transfer,length has increased by 1

      	{
      		deleteMarkers();
      		
      	
				
                
           
           
			
			for(var i =1;i<list.length-1;i++)
			{
						var myLatlng = new google.maps.LatLng(list[i][2],list[i][3]);
						var marker = new google.maps.Marker({
    					position: myLatlng,
    					icon: whiteCircle,
    					stop_no: list[i][0],
    					stop_name: list[i][4]
            
          
   						 
});
					
// To add the marker to the map, call setMap();

//marker.setMap(map);
markers.push(marker);
//global_list[0]=markers;

//popupDirections(marker);



			}
			console.log("Markers length");
console.log(markers.length);
//marker_copy = markers;
//global_list[0]  = markers.slice();
			

			function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
          popupDirections(markers[i]);

        }
      }
        function deleteMarkers() {
        	//marker_copy = markers;
        	console.log("Flag 2 is");
        	console.log(flag2);
        	console.log(markers);

        	if(flag2!=0)
        	{
        		console.log(markers.length);
        		setMapOnAll(null);
        		markers=[];

        	}
        	//flag2=0;
        
        //marker_copy = [];
      }
      setMapOnAll(map);
      


		
	
		
		function popupDirections(marker) {
            
                //This function created listener listens for click on a marker to show information specific to that marker
                google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent('<b>'+"Stop No:"+'</b>'+marker.stop_no+'<br>'+'<b>'+"Stop Name:"+'</b>'+marker.stop_name);  infowindow.open(map, marker); //This opens the infowindow at the marker
                });
            }

		//document.getElementById("info_panel").innerHTML=" ";
      	document.getElementById("demo1").innerHTML = direction_data[data2][1];
      	document.getElementById("demo2").innerHTML = direction_data[data2][2];
      	document.getElementById("demo3").innerHTML = direction_data[data2][3];
      	document.getElementById("demo4").innerHTML = direction_data[data2][4];
      	document.getElementById("demo5").innerHTML = direction_data[data2][6];
      	document.getElementById("demo6").innerHTML = direction_data[data2][8]
      	document.getElementById("demo7").innerHTML = direction_data[data2][9];
      	document.getElementById("demo8").innerHTML = direction_data[data2][10];
      	document.getElementById("demo9").innerHTML = direction_data[data2][11];
      	document.getElementById("demo10").innerHTML = direction_data[data2][12];
      	document.getElementById("demo11").innerHTML = direction_data[data2][13];
      	//document.getElementById("demo12").innerHTML = direction_data[14];
      	
      	document.getElementById("demo12").innerHTML = direction_data[data2][15];
      	document.getElementById("demo13").innerHTML = direction_data[data2][16];
      	document.getElementById("demo12").innerHTML = direction_data[data2][17];
      	document.getElementById("demo14").innerHTML = "";
      	flag2 = 1;
}
else
{  //This is to display transfer bus journey
			//console.log("hi");
			//console.log(list.length);
			deleteMarkers();
			for(var i =0;i<list.length;i++)

			{
				for(var j = 1;j<list[i].length-1;j++)
				{
					//console.log("inside for loop");
					//console.log(list_intermediate_bus_stops[0][1][2][2]);
						var myLatlng = new google.maps.LatLng(list[i][j][2],list[i][j][3]);
						var marker = new google.maps.Marker({
    					position: myLatlng,
    					icon: whiteCircle,
    					stop_no: list[i][j][0],
    					stop_name: list[i][j][4]
            
          
   						 
});
					
// To add the marker to the map, call setMap();
markers.push(marker);
//marker.setMap(map);
//popupDirections(marker);



			}
		}
		function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
          popupDirections(markers[i]);

        }
      }
        function deleteMarkers() {
        	//marker_copy = markers;
        	console.log("Flag 2 is");
        	console.log(flag2);
        	console.log(markers);

        	if(flag2!=0)
        	{
        		console.log(markers.length);
        		setMapOnAll(null);
        		markers=[];

        	}
        	//flag2=0;
        
        //marker_copy = [];
      }
      setMapOnAll(map);
	
		
		function popupDirections(marker) {
            
                //This function created listener listens for click on a marker to show information specific to that marker
                google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent('<b>'+"Stop No:"+'</b>'+marker.stop_no+'<br>'+'<b>'+"Stop Name:"+'</b>'+marker.stop_name);  infowindow.open(map, marker); //This opens the infowindow at the marker
                });
            }
	//document.getElementById("info_panel").innerHTML=" ";
	document.getElementById("demo1").innerHTML = "Departure Bus Stop: "+direction_data[data2][0];
      	document.getElementById("demo2").innerHTML = "Predicted Arrival Time: "+ direction_data[data2][1];
      	document.getElementById("demo3").innerHTML = "Headsign: "+direction_data[data2][2];
      	document.getElementById("demo4").innerHTML = "Bus Number: "+direction_data[data2][3];
      	document.getElementById("demo5").innerHTML = "No. of stops to travel: "+direction_data[data2][4];
      	document.getElementById("demo6").innerHTML = "Transit arrival bus stop: "+direction_data[data2][5]
      	document.getElementById("demo7").innerHTML = "Transfer:"+direction_data[data2][6];
      	document.getElementById("demo8").innerHTML = "Transit Departure bus stop: "+direction_data[data2][7];
      	document.getElementById("demo9").innerHTML = "Predicted Arrival Time: "+direction_data[data2][8];
      	document.getElementById("demo10").innerHTML = "Headsign: "+direction_data[data2][9];
      	document.getElementById("demo11").innerHTML = "Bus Number: "+direction_data[data2][10];
      	//document.getElementById("demo12").innerHTML = direction_data[14];
      	document.getElementById("demo12").innerHTML = "No. of stops to travel: "+direction_data[data2][11];
      	document.getElementById("demo13").innerHTML = "Arrival bus stop: "+direction_data[data2][12];
      	document.getElementById("demo14").innerHTML = "Arrival time to final bus stop:" + direction_data[data2][13] ;
      	flag2 = 1;

}

}
      function display_direction_data_front_end(response,data)
      {
      	if(data!='default')
      	{
      		deleteMarkers();
      	function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
         

        }
      }
        function deleteMarkers() {
        	//marker_copy = markers;
        	
        	console.log(markers);

        		console.log(markers.length);
        		setMapOnAll(null);
        		markers=[];

        	
        }

        console.log("data is",data);
       


        if(response['routes'][data]['legs'][0]['steps'].length==3)
        {
        	console.log(data);
      		    	console.log(response['routes'][data]['legs'][0]['steps'][1]['transit']['line']['short_name']);
      //	response = response.json()
      document.getElementById("demo1").innerHTML = response['routes'][data]['legs'][0]['steps'][0]['instructions'];
       document.getElementById("demo2").innerHTML = "Time to bus stop: "+ response['routes'][data]['legs'][0]['steps'][0]['duration']['text'];
      	document.getElementById("demo3").innerHTML = "Departure Bus Stop: "+ response['routes'][data]['legs'][0]['steps'][1]['transit']['departure_stop']['name'];
      	document.getElementById("demo4").innerHTML = "Arrival Time (from Google): " + response['routes'][data]['legs'][0]['steps'][1]['transit']['departure_time']['text'];
      	document.getElementById("demo5").innerHTML = "Headsign: "+ response['routes'][data]['legs'][0]['steps'][1]['transit']['headsign'];
      	document.getElementById("demo6").innerHTML = "Bus Number: "+ response['routes'][data]['legs'][0]['steps'][1]['transit']['line']['short_name'];
      	document.getElementById("demo7").innerHTML = "No. of stops: " + response['routes'][data]['legs'][0]['steps'][1]['transit']['num_stops'];
      	document.getElementById("demo8").innerHTML = "Arrival bus stop name: " + response['routes'][data]['legs'][0]['steps'][1]['transit']['arrival_stop']['name'];
      	document.getElementById("demo9").innerHTML = "Arrival time (from Google):"+ response['routes'][data]['legs'][0]['steps'][1]['transit']['arrival_time']['text'];
      	document.getElementById("demo10").innerHTML = "Walking time to the destination: " + response['routes'][data]['legs'][0]['steps'][2]['duration']['text'];
      	document.getElementById("demo11").innerHTML =" ";
      	document.getElementById("demo12").innerHTML =" ";
      	document.getElementById("demo13").innerHTML =" ";
      	document.getElementById("demo14").innerHTML  = " ";
      	

        }

        else
        {
        	if(response['routes'][data]['legs'][0]['steps'].length==4)
        	{
        		document.getElementById("demo1").innerHTML = "Departure Stop: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['departure_stop']['name'];
        		document.getElementById("demo2").innerHTML = "Arrival Time (from Google):: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['departure_time']['text'];
        		document.getElementById("demo3").innerHTML = "Headsign: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['headsign'];
        		document.getElementById("demo4").innerHTML = "Bus Number: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['line']['short_name'];
        		document.getElementById("demo5").innerHTML = "No. of stops: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['num_stops'];
        		document.getElementById("demo6").innerHTML = "Arrival Stop Transit: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['arrival_stop']['name'];
        		document.getElementById("demo7").innerHTML = "Transfer";
        		if(response['routes'][data]['legs'][0]['steps'][2]["travel_mode"]=="TRANSIT")
        		{
	        		document.getElementById("demo8").innerHTML = "Departure Stop: "+response['routes'][data]['legs'][0]['steps'][2]['transit']['departure_stop']['name'];
	        		document.getElementById("demo9").innerHTML = "Arrival Time (From Google): "+response['routes'][data]['legs'][0]['steps'][2]['transit']['departure_time']['text'];
	        		document.getElementById("demo10").innerHTML = "Headsign: "+response['routes'][data]['legs'][0]['steps'][2]['transit']['headsign'];
	        		document.getElementById("demo11").innerHTML = "Bus Number: "+response['routes'][data]['legs'][0]['steps'][2]['transit']['line']['short_name'];
	        		document.getElementById("demo12").innerHTML = "Number of Stops: "+response['routes'][data]['legs'][0]['steps'][2]['transit']['num_stops'];
	        		document.getElementById("demo13").innerHTML = "Final Arrival Stop: "+response['routes'][data]['legs'][0]['steps'][2]['transit']['arrival_stop']['name'];
	        		document.getElementById("demo14").innerHTML = "Arrival Time (From Google):"+response['routes'][data]['legs'][0]['steps'][2]['transit']['arrival_time']['text'];
	        	//	document.getElementById("demo14").innerHTML="";


        		}
        		else
        		{
        			document.getElementById("demo8").innerHTML = "Departure Stop: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['departure_stop']['name'];
	        		document.getElementById("demo9").innerHTML = "Arrival Time (From Google): "+response['routes'][data]['legs'][0]['steps'][3]['transit']['departure_time']['text'];
	        		document.getElementById("demo10").innerHTML = "Headsign: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['headsign'];
	        		document.getElementById("demo11").innerHTML = "Bus Number: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['line']['short_name'];
	        		document.getElementById("demo12").innerHTML = "Number of Stops: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['num_stops'];
	        		document.getElementById("demo13").innerHTML = "Final Arrival Stop: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['arrival_stop']['name'];
	        		document.getElementById("demo14").innerHTML = "Arrival Time (From Google):"+response['routes'][data]['legs'][0]['steps'][3]['transit']['arrival_time']['text'];
	        	//	document.getElementById("demo14").innerHTML="";


        		}
        	}
        	if(response['routes'][data]['legs'][0]['steps'].length==5)
        	{
        		document.getElementById("demo1").innerHTML = "Departure Stop: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['departure_stop']['name'];
        		document.getElementById("demo2").innerHTML = "Arrival Time (from Google):: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['departure_time']['text'];
        		document.getElementById("demo3").innerHTML = "Headsign: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['headsign'];
        		document.getElementById("demo4").innerHTML = "Bus Number: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['line']['short_name'];
        		document.getElementById("demo5").innerHTML = "No. of stops: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['num_stops'];
        		document.getElementById("demo6").innerHTML = "Arrival Stop Transit: "+response['routes'][data]['legs'][0]['steps'][1]['transit']['arrival_stop']['name'];
        		document.getElementById("demo7").innerHTML = "Transfer";

        		document.getElementById("demo8").innerHTML = "Departure Stop: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['departure_stop']['name'];
	        	document.getElementById("demo9").innerHTML = "Arrival Time (From Google): "+response['routes'][data]['legs'][0]['steps'][3]['transit']['departure_time']['text'];
	        	document.getElementById("demo10").innerHTML = "Headsign: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['headsign'];
	        	document.getElementById("demo11").innerHTML = "Bus Number: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['line']['short_name'];
	        	document.getElementById("demo12").innerHTML = "Number of Stops: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['num_stops'];
	        	document.getElementById("demo13").innerHTML = "Final Arrival Stop: "+response['routes'][data]['legs'][0]['steps'][3]['transit']['arrival_stop']['name'];
	        	document.getElementById("demo14").innerHTML = "Arrival Time (From Google):"+response['routes'][data]['legs'][0]['steps'][3]['transit']['arrival_time']['text'];
	        	//document.getElementById("demo14").innerHTML="";





        	
        }
    }
        		



        	}
        
        }


	




      



      		

      	


      	
  
      	/*
      	document.getElementById("demo1").innerHTML = direction_data[data][1];
      	document.getElementById("demo2").innerHTML = direction_data[data][2];
      	document.getElementById("demo3").innerHTML = direction_data[data][3];
      	document.getElementById("demo4").innerHTML = direction_data[data][4];
      	document.getElementById("demo5").innerHTML = direction_data[data][6];
      	document.getElementById("demo6").innerHTML = direction_data[data][8]
      	document.getElementById("demo7").innerHTML = direction_data[data][9];
      	document.getElementById("demo8").innerHTML = direction_data[data][10];
      	document.getElementById("demo9").innerHTML = direction_data[data][11];
      	document.getElementById("demo10").innerHTML = direction_data[data][12];
      	document.getElementById("demo11").innerHTML = direction_data[data][13];
      	//document.getElementById("demo12").innerHTML = direction_data[14];
      	document.getElementById("demo13").innerHTML = direction_data[data][15];
      	document.getElementById("demo14").innerHTML = direction_data[data][16];

*/

      
            function initialize() {
            		var options = {
   							 //types: ['(cities)'],
   							 componentRestrictions: { country: 'ie' }
						};
                    var input = document.getElementById('searchTextField');
                    var autocomplete = new google.maps.places.Autocomplete(input,options);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude1 = place.geometry.location.lat();
                        var longitude1=place.geometry.location.lng();
                        arr[0] = latitude1;
                        arr[1] = longitude1;
                       
                        //var m=0;
                       // getDistanceFromLatLonInKm(latitude,longitude,m);
                    });
        
                }
                 function initialize2() {
                 	var options = {
   							 //types: ['(cities)'],
   							 componentRestrictions: { country: 'ie' }
						};
                    var input = document.getElementById('searchTextField2');
                    var autocomplete = new google.maps.places.Autocomplete(input,options);
                    google.maps.event.addListener(autocomplete, 'place_changed', function () {
                        var place = autocomplete.getPlace();
                        var latitude2 = place.geometry.location.lat();
                        var longitude2=place.geometry.location.lng();
                        arr[2] = latitude2;
                        arr[3] = longitude2;
                       // document.getElementById("demo6").innerHTML = arr.length;
                      //  test_func();
                      //  var m=1;
         
                     //   getDistanceFromLatLonInKm(latitude,longitude,m);
           
                    });
                }
                function test_func()
                {
                	var source = document.getElementById("searchTextField").value;
                var dest  = document.getElementById("searchTextField2").value;
                 var selected_date = document.getElementById("mydate").value;
                 var selected_time = document.getElementById("mytime").value;
                //document.getElementById("demo1").innerHTML = source;
                //document.getElementById("demo3").innerHTML = dest;
                var depart_time,datetime_UTC,hr_mins,hr,mins,hr_mins,mins_ms;
              
                var origin = source;
                var destination = dest;
                var departure_date = selected_date;
                var departure_time = selected_time;
               

               $.ajax({
   					type: "POST",
   					url: '{{ 'my-ajax-test/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}', origin: origin, destination:destination,departure_date: departure_date,departure_time: departure_time },
   					success: function(response){
               		console.log(response);
               		//var myObj = JSON.parse("response".replace(/&quot;/g,"\""));
               		if(response=="Error")
               		{
               			alert("Currently no nearby bus stops seems to be operating...kindly try again in some time")
               		}
               		else
               		{
               			var myObj =  JSON.parse(response);
               		//document.getElementById("demo5").innerHTML=myObj.result;

               		//var result_data = JSON.parse(myObj.result); commented 15/07

               		//document.getElementById("demo6").innerHTML= result_data[0];
               		var direction_data = myObj.list_with_alternate_routes;
               		//document.getElementById("demo1").innerHTML = direction_data[0];
               		var list_intermediate_bus_stops = myObj.list_intermediate_bus_stops_alternate_stops;
               		//
               		var list_bus_lines =  myObj.list_bus_lines;
               		var departure_date_time = parseInt(myObj.departure_date_time);
               		console.log(direction_data);
               		console.log(list_intermediate_bus_stops);
               		console.log(list_bus_lines);

               		//change_map(result_data,list_intermediate_bus_stops,list_bus_lines,direction_data,departure_date_time); Commented 15/7..taking result_data out

               		change_map(list_intermediate_bus_stops,list_bus_lines,direction_data,departure_date_time);
               	//	display_direction_data(direction_data);


               		}
               		

               		 //window.location = 'bus/real_time_route.html';

            }

   				
});
        return false;

                }
                var map, infoWindow;
                function show_closest_bus_stops(closest_3_stops,closest_3_stops_bus_info,current_latitude,current_longitude) {

       			//var directionsDisplay = new google.maps.DirectionsRenderer;
        		//var directionsService = new google.maps.DirectionsService;

        		var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 14};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    }); 

          
                infoWindow = new google.maps.InfoWindow;
                	 var pos = {
              lat: current_latitude,
              lng: current_longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('My Location');
            infoWindow.open(map);
            map.setCenter(pos);

                
                
		for(var i = 0;i<closest_3_stops.length;i++)
		{
			x = closest_3_stops_bus_info[i].length;
			var z=" ";
		for(var j=0;j<x;j++)
			{
			z = z+closest_3_stops_bus_info[i][j][0]+" "+"("+closest_3_stops_bus_info[i][j][1]+")"+","+" ";
			}

						var myLatlng = new google.maps.LatLng(closest_3_stops[i][1],closest_3_stops[i][3]);
						var marker = new google.maps.Marker({
    					position: myLatlng,
    				//	icon: whiteCircle,
    					stop_no: closest_3_stops[i][7],
    					stop_name: closest_3_stops[i][5],
    					bus_list_headsigns: z
            
          
   						 
});
					
// To add the marker to the map, call setMap();
marker.setMap(map);
popupDirections(marker);

//+'<br>'+'<b>'+"Buses and Headsigns:"+'</b>'+marker.bus_list_headsigns


			
	
		}

	
            function popupDirections(marker) {
            
                //This function created listener listens for click on a marker to show information specific to that marker
                google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent('<b>'+"Stop No: "+'</b>'+marker.stop_no+'<br>'+'<b>'+"Stop Name: "+'</b>'+marker.stop_name+'<br>'+'<b>'+"Buses and Headsigns: "+'</b>'+marker.bus_list_headsigns);  infowindow.open(map, marker); //This opens the infowindow at the marker
                });
            }
            }

                function getLocation() {
  					if (navigator.geolocation) {
   						 navigator.geolocation.getCurrentPosition(showPosition);
  					} else { 
  						alert("Geolocation is not supported by this browser");
    			//	document.getElementById("showlatlng").innerHTML = "Geolocation is not supported by this browser.";
  						}
					}

				function showPosition(position) {
  		
  				var current_latitude = parseFloat(position.coords.latitude);
  				var current_longitude = parseFloat(position.coords.longitude);
  			
  				 
  			



  				// The below ajax call is for finding nearest bus stops to a user's location
  				$.ajax({
   					type: "POST",
   					url: '{{ 'my-nearest-bus-stop/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}', current_latitude: current_latitude, current_longitude:current_longitude },
   					success: function(response){
               		console.log(response);
               		
               		if(response=="Error")
               		{
               			alert("No nearby bus stops found..try after some time/from different place");
               		}
               		else
               		{
               			var myObj =  JSON.parse(response);
               		
               		var closest_3_stops_bus_info = myObj.closest_3_stops_bus_info;
               		var closest_3_stops = myObj.closest_3_stops;
               		

             //  	console.log("test_success");
             //  	console.log(closest_3_stops);
             //  	console.log(closest_3_stops_bus_info);
               	show_closest_bus_stops(closest_3_stops,closest_3_stops_bus_info,current_latitude,current_longitude);


               		}
               		

               		

            }

   				
});

				}

				var k=0;
				var save_favourites = new Array();
				localStorage.removeItem("array"); //Refreshing/Clearing the web storage for evry ctrl+f5

				function savetrip()
				{
						var source = document.getElementById("searchTextField").value;
                		var dest  = document.getElementById("searchTextField2").value;
					// Check browser support
					if (typeof(Storage) !== "undefined") {
  					// Store
  					save_favourites.push(source);
  					save_favourites.push('/');
  					save_favourites.push(dest);
  					save_favourites.push('/');
  					//localStorage.setItem("source"+k, source);
  					localStorage.setItem("array",save_favourites);

  				
  
  				
			} else {
  				alert("Sorry, Information cannot be saved at the moment") ;
}


				}

				function fetchsavedtrips()
				{
					// Retrieve
					var list_fave_trips = localStorage.getItem("array");
					list_fave_trips = list_fave_trips.slice(0,list_fave_trips.length-2);
					 list_fave_trips = list_fave_trips.split(",/,");
			
				document.getElementById("myTable").innerHTML="";
				 var table = document.getElementById("myTable");//can be put inside the for-loop also


			
				for(var i= 0;i<(list_fave_trips.length)-1;i=i+2)
				{
						
 				 var row = table.insertRow(0);
  				var cell1 = row.insertCell(0);
 				 var cell2 = row.insertCell(1);
 				 var cell3 = row.insertCell(2);
 				 var cell4 = row.insertCell(3);
 				 
 				 var first_letter = list_fave_trips[i].charAt(0);
 				 
 				 if(first_letter==',' )
 				 {
 				 	list_fave_trips[i] = list_fave_trips[i].replace(",", "");

 				 }
 				 //list_fave_trips[i+1] = list_fave_trips[i+1].replace(",", "");

 				 //From here till line 1239, its dealing with special characters in a address like ST. Patrick's Cathedral where apostrophe will be a delimieter so here we just add a \ to escape that if its present in a string
 				 insert = function insert(main_string, ins_string, pos) {
   						if(typeof(pos) == "undefined") {
    					 pos = 0;
 						}
   						if(typeof(ins_string) == "undefined") {
   						 ins_string = '';
  						}
   						return main_string.slice(0, pos) + ins_string + main_string.slice(pos);
   					}
 				 var str1= list_fave_trips[i];
				 var indices1 = [];
				for(var j=0; j<str1.length;j++) {
    if (str1[j] === "'") indices1.push(j);
}
console.log(indices1);
if(indices1.length!=0)
{
	var count=0;
	for(var j=0;j<indices1.length;j++)
	{
		if(count==0)
		{
			str1 = insert(str1,'\\',indices1[j]);
		console.log("Escape character added",str1);

		}
		else
		{
			str1 = insert(str1,'\\',indices1[j]+count);
		console.log("Escape character added",str1);

		}
		count++;
		

	}
}
				 var str2 = list_fave_trips[i+1];
				 var indices2 = [];
				for(var j=0; j<str2.length;j++) {
    if (str2[j] === "'") indices2.push(j);
}
console.log(indices2);

if(indices2.length!=0)
{
	var count=0;
	for(var j=0;j<indices2.length;j++)
	{
		if(count==0)
		{
			str2 = insert(str2,'\\',indices2[j]);
		console.log("Escape character added",str2);

		}
		else
		{
			str2 = insert(str2,'\\',indices2[j]+count);
		console.log("Escape character added",str2);

		}
		count++;
		

	}
}


					
  				cell1.innerHTML = list_fave_trips[i];
  				cell2.innerHTML = list_fave_trips[i+1];
  				cell3.innerHTML = '<input type="button" value="Use this trip" onClick="Selected(\''+str1+"/"+str2+'\')"/>' ;
  				cell4.innerHTML = '<input type="button" value="Delete" onClick="Delete(\''+str1+"/"+str2+'\')"/>' ;
  			//	cell4.innerHTML = "<input type='button' value='Delete' onClick='Delete(\""+list_fave_trips[i]+'/'+list_fave_trips[i+1]+"\")'/>" ;

  				

  				//"<button onclick='Selected();'>"+"Use this trip"+"</button>"
  				




				}

				
				
				

    			//document.getElementById("result2").innerHTML = localStorage.getItem("lastname");



				}

				 function Selected(value)
				{
					//console.log(value);
					var source_destination = value.split("/");
					var source = source_destination[0];
					var destination = source_destination[1];
					//console.log(source);
					//console.log(destination);
					document.getElementById("searchTextField").value = source;
					document.getElementById("searchTextField2").value = destination;

				}

				function Delete(value)
				{
					console.log("Inside Delete");

					var list_all_trips = localStorage.getItem("array");
					//console.log(typeof(list_all_trips));
					//console.log(list_all_trips);
					//console.log("Inside Delete Function");
					//console.log(value);
					var source_destination = value.split("/");
					var source = source_destination[0];
					var destination = source_destination[1];
					//console.log(source+',/,'+destination+',/');
					//console.log(list_all_trips.search(source+',/,'+destination+',/'));
					var string = source+',/,'+destination+',/';
					list_all_trips = list_all_trips.replace(string,"");
					//console.log("After deleting elements");
					//console.log(list_all_trips);
					var position = save_favourites.indexOf(source);
					if(save_favourites[position+2]==destination && position%2==0)
					{
						//console.log("Position is: ",position);
						save_favourites.splice(position,4);
						//console.log("Save Favourites Inside Delete Inside if");
					//console.log(save_favourites);
					}
					else
					{
						for(var i=position;i<save_favourites.length;i=i+4)
						{
							var new_position = save_favourites.indexOf(source,i);
							//console.log("New position is",new_position);
							
							if(new_position%2==0 && save_favourites[new_position+2]==destination)
							{

								save_favourites.splice(new_position,4);
								//console.log("Save Favourites Inside Delete Inside Else");
					//console.log(save_favourites);
								break;

							}
							
						}
					}
					//console.log("Save Favourites Inside Delete");
					//console.log(save_favourites);
					//save_favourites = list_all_trips;
					localStorage.setItem("array",save_favourites);
					fetchsavedtrips();

				}
				//document.getElementById("select2").style.display = "none";

				function show_tourist_places_and_create_drop_down(list_tourist_places) {

       			//var directionsDisplay = new google.maps.DirectionsRenderer;
        		//var directionsService = new google.maps.DirectionsService;

        		//Will create a drop_down of all the tourist destinations in Dublin
						document.getElementById("select2").style.display = "block";

						document.getElementById("select2").innerHTML = "";
						
						document.getElementById("tourist_info").style.display = "block";

						var select = document.getElementById("select2");
						//var tourist_places = ["GUINNESS STOREHOUSE","ST PATRICK'S CATHEDRAL","CHRIST CHURCH CATHEDRAL","EPIC THE IRISH EMIGRATION MUSEUM","DUBLIN CASTLE","KILMAINHAM GAOL","LITTLE MUSEUM OF DUBLIN","DUBLIN ZOO","PHOENIX PARK","ST STEPHEN'S GREEN","TEMPLE BAR","NATIONAL GALLERY OF IRELAND"];
						for(var i=0;i<list_tourist_places.length;i++)
						{
							var option = document.createElement("OPTION");
							var txt = document.createTextNode(list_tourist_places[i][0]);
							option.appendChild(txt);
							option.setAttribute("value",list_tourist_places[i][4]);
							select.insertBefore(option,select.lastChild);
						}

						

        		var myCenter = {lat: 53.349605, lng:-6.264175 };  
                var mapCanvas = document.getElementById("map");
                var mapOptions = {center: myCenter, zoom: 12};
                var map = new google.maps.Map(mapCanvas, mapOptions);
                infowindow = new google.maps.InfoWindow({  
                    maxWidth: 355
                    }); 

          /*
                infoWindow = new google.maps.InfoWindow;
                	 var pos = {
              lat: current_latitude,
              lng: current_longitude
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('My Location');
            infoWindow.open(map);
            map.setCenter(pos);

            */  //this commented code is to show/set user's current location on map 



         var image = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';       
                
		for(var i=0;i<list_tourist_places.length;i++)
		{
			
						var myLatlng = new google.maps.LatLng(list_tourist_places[i][1],list_tourist_places[i][2]);
						var marker = new google.maps.Marker({
    					position: myLatlng,
    					icon: image,
    					place_name: list_tourist_places[i][0],
    					place_description: list_tourist_places[i][3]
    					
            
          
   						 
});
					
// To add the marker to the map, call setMap();
marker.setMap(map);
popupDirections(marker);

//+'<br>'+'<b>'+"Buses and Headsigns:"+'</b>'+marker.bus_list_headsigns


			
	
		}

	
            function popupDirections(marker) {
            
                //This function created listener listens for click on a marker to show information specific to that marker
                google.maps.event.addListener(marker, 'click', function () {
                infowindow.setContent('<b>'+"Place Name: "+'</b>'+marker.place_name+'<br>'+'<b>'+"Legend: "+'</b>'+marker.place_description);  infowindow.open(map, marker); //This opens the infowindow at the marker
                });
            }
            
            }

				function TouristMode()
				{
					var x = document.getElementById("tourist").checked;

					console.log(x);
					if(x==true)
					{
						



  				// The below ajax call is for finding nearest bus stops to a user's location
  				$.ajax({
   					type: "POST",
   					url: '{{ 'my-tourist-places/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
   					success: function(response){
               		console.log(response);
               		
               		if(response=="Error")
               		{
               			alert("Tourist Mode is having some issue...please try again in some time");
               		}
               		else
               		{
               			var myObj =  JSON.parse(response);
               		
               			var list_tourist_places = myObj.list_tourist_places;
               			
               			show_tourist_places_and_create_drop_down(list_tourist_places);

             //  	console.log("test_success");
             //  	console.log(closest_3_stops);
             //  	console.log(closest_3_stops_bus_info);
               	//show_closest_bus_stops(closest_3_stops,closest_3_stops_bus_info,current_latitude,current_longitude);


               		}
               		

               		

            }

   				
});
						
					}

					else
					{
						//clear the output
						document.getElementById("tourist_info").style.display = "none";
						document.getElementById("select2").style.display = "none";
						myMap();
					}

					//alert("Radio button selected");
				}

				  
				//This function is to assign user's current location as the source in case tourist mode is on and the user selects any tourist places option from dropdown which is the destination. It is called from getSelectedValue()
				function showPosition2(position) {
  		
  				var current_latitude = parseFloat(position.coords.latitude);
  				var current_longitude = parseFloat(position.coords.longitude);
  				var google_map_pos = new google.maps.LatLng( current_latitude, current_longitude );
 
                /* Use Geocoder to get address */
                var google_maps_geocoder = new google.maps.Geocoder();
                google_maps_geocoder.geocode(
                    { 'latLng': google_map_pos },
                    function( results, status ) {
                        if ( status == google.maps.GeocoderStatus.OK && results[0] ) {
                            console.log( results[0].formatted_address );
                            alert("Default: Your Current Location is used as the origin...You can change it manually in the source bar");
                            document.getElementById("searchTextField").value = results[0].formatted_address;
                        }
                    }
                );
  			}
  				//This function is to get the value to see which tourist place has been chsoen by the user from drop-down menu
				function getSelectedValue()
				{
					var selected_tourist_place = document.getElementById("select2").value;
					console.log("selected tourist place is",selected_tourist_place);
					document.getElementById("searchTextField2").value = selected_tourist_place;
					if (navigator.geolocation) {
   						 navigator.geolocation.getCurrentPosition(showPosition2);
  					} else { 
  						alert("Geolocation is not supported by this browser");
    			//	document.getElementById("showlatlng").innerHTML = "Geolocation is not supported by this browser.";
  						}

					//document.getElementById("searchTextField").value = source;
					
				}
				//getSelectedValue();

                // Fetching weather data: related code Adding on 19/06

                //Fetching weather data from Open Weather API. This script is executed only once when the page loads for the first time
                $.ajax({
   					type: "POST",
   					url: '{{ 'my-weather-data/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}', data:0 },
   					success: function(response){
               		console.log(response);
               		//var myObj = JSON.parse("response".replace(/&quot;/g,"\""));
               		
               		

               		 //window.location = 'bus/real_time_route.html';

            }

   				
});
                // Fetching data directly from the OpenWeather API after every 5000 seconds to auto - update the weather related deatils

                var myVar=setInterval(myTimer,100000);

                //Commenting it to prevent api calls to open weather, later uncomment it
                /*
                function myTimer()
                {
                	      $.ajax({
   					type: "POST",
   					url: '{{ 'my-weather-data/' }}',
   					data: { csrfmiddlewaretoken: '{{ csrf_token }}', data:0 },
   					success: function(response){
               		console.log(response);
               		//var myObj = JSON.parse("response".replace(/&quot;/g,"\""));
               		
               		

               		 //window.location = 'bus/real_time_route.html';

            }

   				
});


                }*/

          
                /* Commented on 19-06 (Getting weather details code)

                // Fetch real-time weather data on page load
$.getJSON("http://api.openweathermap.org/data/2.5/weather?id=7778677&APPID=a4822db1b5634c2e9e25209d1837cc69&units=metric",
  function(response_5) {
    document.getElementById("coverage").innerHTML = response_5.weather[0].main;
    document.getElementById("temp").innerHTML = response_5.main.temp + "°C";
    document.getElementById("wind").innerHTML = response_5.wind.speed + "km/h";
  })

// function to call the weather forecast route every 5000 sec
var myVar=setInterval(myTimer,100000);
function myTimer() {
  $.getJSON($SCRIPT_ROOT + '/weather', {post: 0}, function(data) {
    var response_3=({{ data|safe }})
    var response_3 = data;
    document.getElementById("coverage").innerHTML = response_3[2];
    document.getElementById("temp").innerHTML = response_3[0] + "°C";
    document.getElementById("wind").innerHTML = response_3[1] + "km/h";
  })
}
*/
            
            google.maps.event.addDomListener(window, 'load', initialize); 

        </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBi-bH5_sngxNibrgygRZDhmAv2fK5hzus&callback=myMap&libraries=places"></script>
    </body>
</html>
